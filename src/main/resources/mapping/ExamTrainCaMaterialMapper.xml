<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.upc.dao.ExamTrainCaMaterialMapper">
  <resultMap id="BaseResultMap" type="com.example.upc.dataobject.ExamTrainCaMaterial">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 29 10:58:28 CST 2019.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="ca_id" jdbcType="INTEGER" property="caId" />
    <result column="course_id" jdbcType="INTEGER" property="courseId" />
    <result column="train_material_id" jdbcType="INTEGER" property="trainMaterialId" />
    <result column="completion_rate" jdbcType="REAL" property="completionRate" />
    <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
    <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
    <result column="operator" jdbcType="VARCHAR" property="operator" />
    <result column="operate_time" jdbcType="TIMESTAMP" property="operateTime" />
    <result column="operate_ip" jdbcType="VARCHAR" property="operateIp" />
  </resultMap>
  <resultMap id="PersonParamMap" type="com.example.upc.controller.param.TrainPersonParam">
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="id_number" jdbcType="VARCHAR" property="idNumber" />
    <result column="telephone" jdbcType="VARCHAR" property="telephone" />
    <result column="sexy" jdbcType="INTEGER" property="sexy" />
    <result column="industry" jdbcType="INTEGER" property="industry" />
    <result column="work_type" jdbcType="INTEGER" property="workType" />
    <result column="company_name" jdbcType="VARCHAR" property="companyName" />
    <result column="photo" jdbcType="VARCHAR" property="photo" />
    <result column="electronic_number" jdbcType="VARCHAR" property="electronicNumber" />
    <result column="train_id" jdbcType="VARCHAR" property="trainId" />
    <result column="train_name" jdbcType="VARCHAR" property="trainName" />
    <result column="completion_rate" jdbcType="REAL" property="completionRate" />
    <result column="ca_score" jdbcType="REAL" property="caScore" />
    <result column="all_score" jdbcType="REAL" property="allScore" />
    <result column="business_address" jdbcType="VARCHAR" property="businessAddress" />
    <result column="credit_number" jdbcType="VARCHAR" property="creditNumber" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 29 10:58:28 CST 2019.
    -->
    id, ca_id,course_id,train_material_id, completion_rate, start_time, end_time, operator, operate_time,
    operate_ip
  </sql>

  <delete id="deleteByCaId" parameterType="int">
    DELETE FROM exam_train_ca_material
    WHERE ca_id = #{caId}
    AND course_id = #{courseId}
  </delete>

  <insert id="batchInsert" parameterType="map">
    insert into exam_train_ca_material (ca_id,course_id,train_material_id,completion_rate ,start_time,end_time,operator, operate_time, operate_ip)
    values
    <foreach collection="caMaterialList" item="caMaterial" separator=",">
      ( #{caMaterial.caId},#{caMaterial.courseId}, #{caMaterial.trainMaterialId},#{caMaterial.completionRate},#{caMaterial.startTime},#{caMaterial.endTime}, #{caMaterial.operator}, #{caMaterial.operateTime}, #{caMaterial.operateIp})
    </foreach>
  </insert>

  <select id="countList" resultType="int">
   SELECT count(1) FROM sys_user as a INNER JOIN supervision_ca as b on a.info_id = b.id where a.user_type = 3
  </select>

  <select id="getPage" resultMap="PersonParamMap">
    SELECT * From
    (SELECT a.*,(ca_score/all_score) as completion_rate From
    (SELECT c.*,
    (SELECT SUM(score*completion_rate) From
    (SELECT a.score,b.ca_id,b.completion_rate,b.operate_time
    FROM exam_train_material as a INNER JOIN exam_train_ca_material as b on a.id=b.train_material_id)
    as a where a.ca_id=c.id) as ca_score,

    (SELECT MAX(operate_time) From exam_train_ca_material WHERE ca_id=c.id)as operate_time,

    (SELECT SUM(b.score) From exam_train_course as a INNER JOIN
    (SELECT a.course_id,b.score from exam_train_course_material as a INNER JOIN exam_train_material as b on a.material_id = b.id) as b
    on a.id=b.course_id where a.worktype= c.work_type) as all_score
    From
    (SELECT a.*,b.business_address,b.id_number as credit_number FROM
    (SELECT a.id,b.company_id,b.name,b.id_number,b.telephone,b.sexy,b.industry,b.work_type,b.company_name,b.photo,b.electronic_number
    FROM sys_user as a INNER JOIN supervision_ca as b on a.info_id = b.id where a.user_type = 3
    <if test="search.idNumber != null and search.idNumber != ''">AND b.id_number LIKE CONCAT('%',#{search.idNumber},'%')</if>
    <if test="search.caName != null and search.caName != ''">AND b.name LIKE CONCAT('%',#{search.caName},'%')</if>
    <if test="search.companyName != null and search.companyName != ''">AND b.company_name LIKE CONCAT('%',#{search.companyName},'%')</if>)
    as a LEFT JOIN supervision_enterprise as b on a.company_id = b.id)as c
    <if test="search.completion == 1 ">)as a)as a WHERE a.completion_rate = 1  ORDER BY a.operate_time DESC limit #{page.offset}, #{page.pageSize}</if>
    <if test="search.completion == 2 ">)as a)as a WHERE a.completion_rate != 1 OR a.completion_rate IS NULL  ORDER BY a.operate_time DESC limit #{page.offset}, #{page.pageSize}</if>
    <if test="search.completion == null ">)as a)as a ORDER BY a.operate_time DESC limit #{page.offset}, #{page.pageSize}</if>
  </select>

  <select id="selectByCaId" parameterType="int" resultType="int">
    SELECT SUM(score*completion_rate) From
                  (SELECT a.score,b.ca_id,b.completion_rate,b.operate_time
                  FROM exam_train_material as a
                  INNER JOIN exam_train_ca_material as b on a.id=b.train_material_id)
    as a where a.ca_id=#{caId}
  </select>
</mapper>